---
title: "Ideas for maps in the ggplot app"
author: "Danny Kaplan"
date: "June 16, 2015"
output: html_document
---

Install the packages
```{r include=FALSE}
x <- c("maptools","ggmap","rgdal","ggplot2","rgeos","dplyr","tidyr","shiny","shinyThemes")
# install.packages(x)
lapply (x,library,character.only=TRUE)

```


Example from <http://spatial.ly/2013/12/introduction-spatial-data-ggplot2/>
```{r}
# Read in the shapefile
sport <- rgdal::readOGR(dsn = "www/London", "london_sport")
# fixes an error in the london_sport file
proj4string(sport) <- CRS("+init=epsg:27700")
```

Convert to a form suited to ggplot:
```{r}
sport.f <- ggplot2::fortify(sport, region = "ons_label")
```

# ===================== For  plotting with ggplot ============
Merge with the data we're interested in displaying. `sport@data` is just a data table that happens to be included in the `sport` object.  Let's see if we can make it work with another data table.
```{r}
sport.f <- merge(sport.f, sport@data, by.x = "id", by.y = "ons_label")
```

Make the map:
```{r}
Map <- 
  ggplot(sport.f, 
         aes(x = long, y = lat, group = group, fill = Partic_Per)) + 
  geom_polygon() + 
  coord_equal() + 
  labs(x = "Easting (m)", y = "Northing (m)", fill = "% Sport Partic.") + 
  ggtitle("London Sports Participation") + 
scale_fill_gradient(low = "white", high = "black")
```


# ===================== For  plotting with ggmap ============
# Base Maps

Reset the coordinate system to degrees lat and long

```{r}
sport.wgs84 <- spTransform(sport, CRS("+init=epsg:4326"))   #shape file
```

Find the bounding box and scale around that
```{r}
b <- bbox(sport.wgs84)
b[1, ] <- (b[1, ] - mean(b[1, ])) * 1.05 + mean(b[1, ])
b[2, ] <- (b[2, ] - mean(b[2, ])) * 1.05 + mean(b[2, ])
# scale longitude and latitude (increase bb by 5% for plot) replace 1.05
# with 1.xx for an xx% increase in the plot size
```

Get the tiles
```{r}
lnd.b1 <- ggmap(get_map(location = b))
```

Merge the shape file with the data
```{r}
foreign::read.dbf(
  file.choose(),
  as.is = TRUE)
sport.wgs84.f <- fortify(sport.wgs84, region = "ons_label")
sport.wgs84.f <- merge(sport.wgs84.f, sport.wgs84@data, by.x = "id", by.y = "ons_label")
```

```{r}
lnd.b1 + 
  geom_polygon(data = sport.wgs84.f, 
               aes(x = long, y = lat, group = group, fill = Partic_Per), 
    alpha = 0.5)
```

# China map

```{r eval=FALSE}
China <- rgdal::readOGR(dsn = "www/China", "ch")
China.f <- ggplot2::fortify(China, region = "ADMIN_NAME")
```

# World Map

Got shapefile from [Geocommons](http://geocommons.com/overlays/33578.html), but a more extensive set is from the [CDC](http://wwwn.cdc.gov/epiinfo/html/shapefiles.htm)

```{r}
world <- rgdal::readOGR(dsn = "WorldCountries", "world_country_admin_boundary_shapefile_with_fips_codes")
```

Convert to a form suited to ggplot:
```{r}
world.f <- ggplot2::fortify(world, region ="CNTRY_NAME")
```

The `region = ` argument is set to one of the variable names in the `.dbf` file that comes with the shape files. You can read this with ....

```{r}
FIPS <- foreign::read.dbf(
  file = "WorldCountries/world_country_admin_boundary_shapefile_with_fips_codes.dbf",
  as.is = TRUE)
```

Making an example:
```{r}
library(DCF)
ours <- CountryData%>% select(id=country, fert)
```

```{r}
ggplot(world.f, aes(x=long, y=lat, group=group)) + geom_path()
```

```{r}
all <- left_join(world.f, ours)
ggplot(all, aes(x=long, y=lat, fill=fert, group=group)) + geom_polygon()
ggplot() + geom_map(data=all, aes(fill=fert, x=long, y=lat, map_id=id), map=world.f)
```

# Another approach

```{r}
library(ggmap)
library(mapproj)
map <- get_map(location = 'minnesota', maptype="hybrid",
               zoom = 9)
ggmap(map)
```

Other locations: state names, continents, countries, ... or latitude/longitude pairs.